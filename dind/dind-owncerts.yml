apiVersion: v1
kind: ConfigMap
metadata:
  name: dind-cert
  namespace: gary
data:
  ca.pem: "-----BEGIN CERTIFICATE-----\r\n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\r\nWIJa\r\n-----END
    CERTIFICATE-----\r\n"
  # cert.pem: "-----BEGIN CERTIFICATE-----\r\nMIIFcjCCA1qgAwIBAgIUHd61ioCMbzuEBJdlW4Q/CLL+5p8wDQYJKoZIhvcNAQEL\r\nBQAwdzELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAlBBMQ0wCwYDVQQHDARNZWNoMQ8w\r\nDQYDVQQKDAZOQVZTVVAxDDAKBgNVBAsMA0JTQzEQMA4GA1UEAwwHZ2FyeS5jYTEb\r\nMBkGCSqGSIb3DQEJARYMZ2FyeUBnYXJ5LmNhMB4XDTIzMDUxMTIwNDAxM1oXDTI0\r\nMDUxMDIwNDAxM1owFjEUMBIGA1UEAwwLZ2FyeS5jbGllbnQwggIiMA0GCSqGSIb3\r\nDQEBAQUAA4ICDwAwggIKAoICAQDQ7rh5x81xNALYWLxBvRJTL+PROKXrhKwt5cto\r\nJTgot8YykfJEleUBrrNSPdixwuj/073zeczPt61hTyiwWKHwP1myhthI8tlwwSgS\r\nIXQS9S261fElTqtmQrCMltrHBOn1tdHOJd6I6bxBmgJFCnwtTUDW5KXqTVXPAG0u\r\n1Xw8lcK5KVVUwAeKoFg20x6vldtpDHLC//CKAC2P3WPbSsMe7qlSFyzovxL+yiRm\r\n/RpDfzsauQURqIpnyxynLGiUQVXrJ1oCpNv/Th8nK/cFsOFxQEQqJhAomMnxIq5l\r\neE4zv1vnVfuWr3C1Rkr1fdQcut+BxQK5wrD/yz8IEXcvqADL4e4QLstkSVUSkI8N\r\nxUy/Ugq/o4pRl8PerAJXF03i+RcMJb7VhcAEmBS2DciN3Ag5BIiZ/2wXv8w3D58k\r\nmWbyJ3FbXXfzvV62WM7w+MrekVnLkwDXms0aJXm2fVCH0z+UVvicdg+O23Nq54XL\r\nbRi2zX6o7WMpv76mVk1aUJW+TV97RJGvEW8O5Vkg5jy7K0DSOovoFX/UkGYmukea\r\nOcWdYGaV2BDMTcqs06A89cEmrxgySmaYjz201yS5CjEsYm5lJYPVsztfRsiwenRJ\r\n5udriNgHjoQ7hey/9yGCw8Wjru1bcokAzUsVWtok7dP6fxS8gUdBcabaAg0KEhk4\r\najGolQIDAQABo1cwVTATBgNVHSUEDDAKBggrBgEFBQcDAjAdBgNVHQ4EFgQUCFTm\r\ntUmo53SzpL97axMI0y1/X/gwHwYDVR0jBBgwFoAU7l9NTNeP8fXpnutQWeRaWlFr\r\nNuAwDQYJKoZIhvcNAQELBQADggIBAHPXpPbCbyr36MWsAcCY56zTRAXyacrCRa0Q\r\nVsys5O3iF9K5tuck0V0LxiG/o6+VFvtQD5irUsiw2nw30955hQ4sD5uroJAqHSnZ\r\n6ZVl/H4/9S7qXj28JxxH8aw+zHY+1/Ot+R5P/awdQHGnwv3n6DuOSnD8Gx/XK+ji\r\nfFhZ1Q2OHrhsdnDYx3VkQx8KwizrBawMtlKTVHruCJxmHNUF00Z7lxL+p//6SWli\r\nVkvSfnwV+muH4IYNrpr1HWTWR1CJTLF1lzUs2fcEnwwz1Oj4wURyZMGdtolF8+Jy\r\nLEMu7FSNrirSX50zzTBesnIhSY8LSNP0evpl5E3VWzoZKxa+8/RYiIrDaG2/gQA7\r\ntvGlSMG/KBAOQGixphm0VJIwytVPMceSrquZTXwDd3sd47y7NXgE7Kfykjm64hBd\r\narCypsaF3qepv0fpXN/jibytApWWzbTcNNvmgwwm0d8ZuRN4WmDwERtixJ8HJYAZ\r\nbs5B5eFbRiSnOinhgOdT15OxyXeNh4gMBmn+zCKvERhv5/2AAHV6h9ZYD1f4b0sO\r\nuWwn+RwNTPR4EIjnsmJqHeAIWuQOLHaU+KwkejGL+7ynPYMgkhmUfbDDgXGnsCvu\r\nb82zc4s2+IeQpVw9HattCXa8xIc9Ox5uMnHXONJIQRcLeYSrJgpVim6tZf7wvUn2\r\nCVfHE1yD\r\n-----END
  #   CERTIFICATE-----\r\n"
  server-cert.pem: "-----BEGIN CERTIFICATE-----\r\n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\r\n-----END
    CERTIFICATE-----\r\n"
  server-key.pem: "-----BEGIN PRIVATE KEY-----\r\n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\r\ndzU7rF7U+pnhCk3XdwxO8gSkxuzV\r\n-----END
    PRIVATE KEY-----\r\n"

---

apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: gary
  name: dind
  labels:
    app: dind
spec:
  replicas: 1
  template:
    metadata:
      name: dind
      labels:
        app: dind
    spec:
      containers:
        - name: dind
          image: docker:dind
          securityContext:
            privileged: true
          # imagePullPolicy: Always
          env:
            - name: DOCKER_TLS_CERTDIR
              value: /certs
      #       - name: SERVER_NAME
      #         value: "SonarQube"
      #       - name: DEFAULT_PLAYER_PERMISSION_LEVEL
      #         value: visitor
      #     volumeMounts:
      #       - mountPath: /data
      #         name: data
          volumeMounts:
            - name: certs-volume
              mountPath: "/certs"    
          command: ["dockerd"]
          args: ["--host=unix:///var/run/docker.sock"
                  ,"--host=tcp://0.0.0.0:2376"
                  ,"--tlsverify"
                  ,"--tlscacert","$(DOCKER_TLS_CERTDIR)/server/ca.pem"
                  ,"--tlscert","$(DOCKER_TLS_CERTDIR)/server/server-cert.pem"
                  ,"--tlskey","$(DOCKER_TLS_CERTDIR)/server/server-key.pem"
                ]                
      # volumes:
      #   - name: data
      #     persistentVolumeClaim:
      #       claimName: dind-disk
      volumes:
        - name: certs-volume
          configMap:
            name: dind-cert
            items:
            - key: ca.pem
              path: server/ca.pem
            # - key: cert.pem
            #   path: client/cert.pem
            - key: server-cert.pem
              path: server/server-cert.pem
            - key: server-key.pem
              path: server/server-key.pem
  selector:
    matchLabels:
      app: dind
---
apiVersion: v1
kind: Service
metadata:
  namespace: gary
  name: dind
spec:
  selector:
    app: dind
  ports:
    - port: 443
      targetPort: 2376
      protocol: TCP
  type: LoadBalancer
#kubectl apply -f dind.yml
#kubectl get pods
#kubectl get services